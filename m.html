<!DOCTYPE html>
<html>
<head>
      <script type="text/javascript">
        var phoneWidth =  parseInt(window.screen.width);
        var phoneScale = phoneWidth/640;
        var ua = navigator.userAgent;
        if (/Android (\d+\.\d+)/.test(ua)){
            var version = parseFloat(RegExp.$1);
            if(version>2.3){
                document.write(‘<meta name="viewport" content="width=640, minimum-scale = ‘+phoneScale+‘, maximum-scale = ‘+phoneScale+‘, target-densitydpi=device-dpi">‘);
            }else{
                document.write(‘<meta name="viewport" content="width=640, target-densitydpi=device-dpi">‘);
            }
        } else {
            document.write(‘<meta name="viewport" content="width=640, user-scalable=no, target-densitydpi=device-dpi">‘);
        }
    </script>
    <title>chat room demo</title>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="javascripts/jquery.min.js"></script>
    <script src="javascripts/bmobSocketIo.js"></script>
    <script src="javascripts/bmob.js"></script>
</head>
<body>
    <h1>chat room demo</h1>
    <div id="data"></div>
    <div>
        昵称<input type="text" style="width:80px" id="name"/>
        内容<input type="text" id="content"/>
        <button name="发送" id="send">发送</button>
    </div>  

  <script type="text/javascript">
<!--
    function sendMsg(){

        var name= $("#name").val();
        var content = $("#content").val();

        if($.trim(name)==""){
            alert("昵称不能为空！");
            return;
        }

         if($.trim(content)==""){
            alert("内容不能为空！");
            return;
        }       

        var Chat = Bmob.Object.extend("Chat");
        var chat = new Chat();
        chat.set("name", $("#name").val());
        chat.set("content", $("#content").val());
        chat.save(null, {
          success: function(object) {           
          },
          error: function(model, error) {            
          }
        });     
    }

    $("#send").click(function(){

        sendMsg();
    });

    //服务器
    BmobSocketIo.initialize("4733f138065d979e5bea5a43bd4bdf0a");
    Bmob.initialize("4733f138065d979e5bea5a43bd4bdf0a", "e78ae2b9cf7e63e9066f6336a6822a1c");
    
   //初始连接socket.io服务器后，需要监听的事件都写在这个函数内
    BmobSocketIo.onInitListen = function() {
      //订阅GameScore表的数据更新事件
      BmobSocketIo.updateTable("Chat");     
    };

      //监听服务器返回的更新表的数据
   BmobSocketIo.onUpdateTable = function(tablename,data) {   
     
     if( tablename=="Chat" ) {
        // alert(tablename);
        var content=$("#data");
        var p = '<p><span style="color:red;">' + data.name+'</span>  '+'<span style="color:green;">'+ data.createdAt+'</span>  '+ ' :<br/> '+data.content+'</p><br/><br/>';
        content.html(content.html()+p);
     }
   };

  //通过“回车”提交聊天信息
   $('#name').keydown(function(e) {
    if (e.keyCode === 13) {
      sendMsg();
    }
  });

  //通过“回车”提交聊天信息
   $('#content').keydown(function(e) {
    if (e.keyCode === 13) {
      sendMsg();
    }
  });
  --!>
  </script>


</body>
</html>
